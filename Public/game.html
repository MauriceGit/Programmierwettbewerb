<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
        <style>
            canvas {
                background-color: #222222; // TODO(henk): Remove this
            }
            .highscore {
                position: fixed;
                color: white;
                top: 10;
                right: 10;
                width: 900px;
                background-color: rgba(150,150,150,0.1);
                //border: 3px solid #73AD21;
            }
            .highscoreEntry {
                margin:5px;
            }
            html, body {
              width:  100%;
              height: 100%;
              margin: 0px;
            }

            .dropbtn {
                //position: absolute;
                background-color: #4CAF50;
                color: white;
                padding: 8px;
                font-size: 12px;
                border: none;
                cursor: pointer;
            }

            .dropbtn:hover, .dropbtn:focus {
                background-color: #3e8e41;
            }

            .dropdown {
                top: 10;
                left: 10;
                z-index: 1;
                position: absolute;
                display: inline-block;
            }

            .dropdown-content {
                display: none;
                position: absolute;
                z-index: 1;
                background-color: #f9f9f9;
                min-width: 300px;
                overflow: auto;
                box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            }

            .dropdown-content a {
                color: black;
                padding: 4px 16px;
                text-decoration: none;
                display: block;
            }

            .dropdown a:hover {background-color: #f1f1f1}

            .hideStats a:hover {background-color: #f1f1f1}
            .hideStats {
                top: 10;
                left: 100;
                z-index: 1;
                position: absolute;
                display: inline-block;
            }

            .show {display:block;}
        </style>
    </head>

    <body>
        <div class="dropdown">
            <button onclick="cameraDropDownHandler()" class="dropbtn">Camera</button>
            <div id="cameraDropDown" class="dropdown-content">
            </div>
        </div>
        <div class="hideStats" tabindex="-1" id="hideStatsId">
            <button onclick="hideStatsHandler()" class="dropbtn">Hide Stats</button>
        </div>

        <canvas id="canvas">Sorry, your browser doesn't support canvas.</canvas>

        <div class="highscore" id="highscore" />

        <script type="text/javascript">
            var sock = null;
            //var wsuri = "ws:localhost:8080/gui/";
            var wsuri = {{.Address}};
            //var wsuri = "ws://192.168.2.187:1234";

            var bots = {};
            var botInfos = {};
            var toxins = {};
            var foods = {};

            var statisticsLocal  = {};
            var statisticsGlobal = {};

            var frametimes = [];
            var numFrametimes = 10;
            var currentFrametime = 0;

                        var context;

            var colors = [
                "rgba(255,  20, 147, 1)",
                "rgba(255,   0,   0, 1)",
                "rgba(255,  69,   0, 1)",
                "rgba(255, 255,   0, 1)",
                "rgba(0  ,  80,   0, 1)",
                "rgba(0  , 255, 255, 1)",
                "rgba(0  , 191, 255, 1)",
                "rgba(0  ,   0, 255, 1)",
                "rgba(255,   0, 255, 1)",
                "rgba(128,   0, 128, 1)",
                "rgba(0  , 255,   0, 1)",
            ];

            // GuiMessagePurpose
            var gmpCreateOrUpdate = "createOrUpdate";
            var gmpDelete         = "delete";

            // DataType
            var dtFood      = "food";
            var dtToxin     = "toxin";
            var dtBot       = "bot";
            var dtBotInfo   = "botInfo";

            // Camera
            var cmShowAll     = 0;
            var cmShowBot     = 1;
            var cameraMode = cmShowAll;
            var cameraBotToFollow = -1;

            var showStats = 1;

            function cameraDropDownHandler() {
                document.getElementById("cameraDropDown").classList.toggle("show");
            }

            function hideStatsHandler() {
                showStats = !showStats;
            }

            window.onclick = function(event) {
                if (!event.target.matches('.dropbtn')) {
                    var dropdowns = document.getElementsByClassName("dropdown-content");
                    var i;
                    for (i = 0; i < dropdowns.length; i++) {
                        var openDropdown = dropdowns[i];
                        if (openDropdown.classList.contains('show')) {
                            openDropdown.classList.remove('show');
                        }
                    }
                }
            }

            function showAll() {
                cameraMode = cmShowAll;
            }

            function showBot(id) {
                cameraMode = cmShowBot;
                cameraBotToFollow = id;
            }

            if (!String.prototype.format) {
              String.prototype.format = function() {
                var args = arguments;
                return this.replace(/{(\d+)}/g, function(match, number) {
                  return typeof args[number] != 'undefined'
                    ? args[number]
                    : match
                  ;
                });
              };
            }

            function makeCSSColor(color) {
                return "rgb({0}, {1}, {2})".format(color.R, color.G, color.B);
            }

            window.onload = function() {
                //
                // Canvas
                //
                var canvas = document.getElementById('canvas');
                var resizeCanvas = function() {
                    canvas.width  = window.innerWidth;
                    canvas.height = window.innerHeight;
                };
                window.onresize = function(event) {
                    resizeCanvas();
                };
                resizeCanvas();

                context = canvas.getContext('2d');

                //
                // Rendering
                //
                window.requestAnimationFrame(render);

                //
                // Updating the highscore
                //
                setInterval(updateHighscore, 1000);

                //
                // Connection
                //
                sock = new WebSocket(wsuri);

                sock.onopen = function() {
                    console.log("connected to " + wsuri);
                }

                sock.onclose = function(e) {
                    console.log("connection closed (" + e.code + ")");
                }
                sock.onmessage = function(e) {
                    // Just ignore this message. It's to test, if the
                    // connection is alive at server side.
                    if (e.data == "alive_test") {
                        return
                    }

                    var message = JSON.parse(e.data);
                    var  guiUpdatedNeeded = false;

                    for (var botId in message.createdOrUpdatedBotInfos) {
                        botInfos[botId] = message.createdOrUpdatedBotInfos[botId];
                        guiUpdatedNeeded = true;
                    }

                    for (var i = 0; i < message.deletedBotInfos.length; i++) {
                        var botId = message.deletedBotInfos[i];
                        delete botInfos[botId];
                        guiUpdatedNeeded = true;
                    }

                    for (var botId in message.createdOrUpdatedBots) {
                        bots[botId] = message.createdOrUpdatedBots[botId];
                    }

                    for (var i = 0; i < message.deletedBots.length; i++) {
                        var botId = message.deletedBots[i];
                        delete bots[botId];
                    }

                    for (var foodId in message.createdOrUpdatedFoods) {
                        foods[foodId] = message.createdOrUpdatedFoods[foodId];
                    }

                    for (var i = 0; i < message.deletedFoods.length; i++) {
                        var foodId = message.deletedFoods[i];
                        delete foods[foodId];
                    }

                    for (var toxinId in message.createdOrUpdatedToxins) {
                        toxins[toxinId] = message.createdOrUpdatedToxins[toxinId];
                    }

                    for (var i = 0; i < message.deletedToxins.length; i++) {
                        var toxinId = message.deletedToxins[i];
                        delete toxins[toxinId];
                    }

                    for (var botId in message.statisticsLocal) {
                        statisticsLocal[botId] = message.statisticsLocal[botId]
                    }

                    for (var botId in message.statisticsGlobal) {
                        statisticsGlobal[botId] = message.statisticsLocal[botId]
                    }

                    if (guiUpdatedNeeded) {
                        var dropdown = $("#cameraDropDown");
                        dropdown.empty();
                        dropdown.append("<a href=\"#\" onclick=\"showAll()\">Show All</a>");
                        $.each(botInfos, function (botId, value) {
                            var botInfo = botInfos[botId];
                            var item = $("<a href=\"#\">" + botInfo.name + " (" + botId + ")" + "</a>");
                            item.css("background-color", makeCSSColor(botInfo.color));
                            item.click(function() {
                                showBot(botId);
                            });
                            dropdown.append(item);
                        });
                    }
                }
            };

            function mapSize(map) {
                count = 0
                for (i in map) {
                    if (map.hasOwnProperty(i)) {
                        count++;
                    }
                }
                return count
            };

            function send(msg) {
                sock.send(msg);
            };

            function radius(mass) {
                return Math.max(1, Math.sqrt(mass / Math.PI)); // TODO(henk): Maybe remove the max(1, ...), when we talked about the sizes of stuff.
            }

            function render() {
                context.setTransform(1, 0, 0, 1, 0, 0);
                context.clearRect(0, 0, canvas.width, canvas.height);

                // Find center of all the blobs
                if (cameraMode == cmShowBot) {
                    if (cameraBotToFollow in bots) {
                        var centerX = 0;
                        var centerY = 0;
                        var numBlobs = 0;
                        var bot = bots[cameraBotToFollow];
                        for (var blobId in bot.blobs) {
                            var blob = bot.blobs[blobId];
                            ++numBlobs;
                            centerX += blob.pos.X;
                            centerY += blob.pos.Y;
                        }
                        centerX /= numBlobs;
                        centerY /= numBlobs;

                        scaleFactorX = (window.innerWidth / bot.viewWindow.size.X) * 1.0 - 0.2;
                        scaleFactorY = (window.innerHeight / bot.viewWindow.size.Y) * 1.0 - 0.2;
                        scaleFactor = Math.min(scaleFactorX, scaleFactorY)


                        //context.setTransform(1, 0, 0, 1, -centerX + window.innerWidth/2, -centerY + window.innerHeight/2);
                        context.scale(scaleFactor, scaleFactor);
                        context.translate(-centerX + window.innerWidth/(2.0*scaleFactor), -centerY + window.innerHeight/(2.0*scaleFactor));

                    } else {
                        cameraMode = cmShowAll;
                    }
                }

                // Render foods
                const FOOD_SIZE = 6;
                context.strokeStyle = "rgb(0, 0, 0)";
                context.fillStyle = "rgb(128, 128, 128)";
                context.lineWidth = 1;
                for (var key in foods) {
                    var food = foods[key];

                    context.beginPath();
                    context.arc(food.pos.X, food.pos.Y, FOOD_SIZE, 0, 2 * Math.PI, false);
                    context.fill();
                }

                // Render toxins
                const NUM_VERTICES = 24;
                const TOXIN_SPIKE_SIZE = 2;
                context.strokeStyle = "green";
                context.fillStyle = colors[10];
                context.lineWidth = 1;
                for (var key in toxins) {
                    var toxin = toxins[key];

                    context.beginPath();
                    for(var i = 0; i < NUM_VERTICES + 1; ++i) {
                      var size = radius(toxin.mass) + (i % 2 == 0 ? 0 : TOXIN_SPIKE_SIZE);
                      var x = size * Math.cos(2 * Math.PI * i / NUM_VERTICES);
                      var y = size * Math.sin(2 * Math.PI * i / NUM_VERTICES);
                      context.lineTo(toxin.pos.X + x, toxin.pos.Y + y);
                    }
                    context.fill();
                    context.stroke();
                }

                // Render bots
                context.strokeStyle = "rgb(255, 255, 255)";
                context.lineWidth = 0.1;
                for (var botId in bots) {
                    var bot = bots[botId];

                    for (var blobId in bot.blobs) {
                        var blob = bot.blobs[blobId];

                        if (botId in botInfos) {
                            context.fillStyle = makeCSSColor(botInfos[botId].color);
                        } else {
                            // Render Error
                            context.fillStyle = "rgb(255, 0, 0)";
                            context.font="12px Courir";
                            context.fillText("Couldn't find the BotInfo", blob.pos.X, blob.pos.Y + 20);
                        }

                        context.beginPath();
                        context.arc(blob.pos.X, blob.pos.Y, radius(blob.mass), 0, 2 * Math.PI, false);
                        context.fill();

                        context.stroke();
                    }

                    if (cameraMode == cmShowBot) {
                        context.beginPath();
                        context.rect(bot.viewWindow.pos.X, bot.viewWindow.pos.Y, bot.viewWindow.size.X, bot.viewWindow.size.Y);
                        context.stroke();
                    }
                }
                                window.requestAnimationFrame(render);
            }

            function calculateHighscore() {
                var tuples = [];
                var maxMass = 0;
                for (var botInfoId in botInfos) {
                    var botInfo = botInfos[botInfoId];
                    var mass = 0;
                    if (botInfoId in bots) {
                        for (var blobId in bots[botInfoId].blobs) {
                            mass += bots[botInfoId].blobs[blobId].mass;
                        }
                    }
                    tuples.push({ id: botInfoId, mass: mass });
                    if (mass > maxMass) {
                        maxMass = mass;
                    }
                }

                tuples.sort(function(a, b) {
                    return b.mass - a.mass;
                });

                return [tuples, maxMass];
            }

            function updateHighscoreForBotId (botInfoId, mass, maxMass) {
                //var mass = tuples[i].mass;
                //var botInfoId = tuples[i].id;
                var botInfo = botInfos[botInfoId];
                var stats = statisticsLocal[botInfoId];
                var paddedName = botInfo.name + "________________________________"
                var shortName = paddedName.substr(0, 13);
                var paddedID = " (id: " + botInfoId + "__________________________"
                var extendedName = shortName + paddedID.substr(0, 10) + ")";

                var containerNode = $("<div></div>");
                containerNode.css({
                    position: "relative",
                    height: 65,
                });
                containerNode.addClass("highscoreEntry");

                var nameNode = $("<span></span>");
                nameNode.css({
                    position: "relative",
                    float: "left", // To position the elements next to each other
                    fontSize: "14px",
                    fontFamily: "Courier New"
                });
                nameNode.html(extendedName);

                var pointsNode = $("<span></span>");
                pointsNode.css({
                    position: "relative",
                    fontSize: "14px",
                    fontFamily: "Courier New",
                    left: 20
                });
                pointString = String(Math.round(mass*100)/100) + "00000"
                pointString = pointString.substr(0, 9)
                pointsNode.html(pointString);


                maxSizeString = String(Math.round(stats.size*100)/100) + "00000";
                maxSizeString = maxSizeString.substr(0, 9);

                survivalString = String(Math.round(stats.survivalTime*100)/100) + "00000";
                survivalString = survivalString.substr(0, 6);
                statsString1 =
                    "---\> " +
                    "Max Size: " + maxSizeString +
                    " Survival: " + survivalString +
                    " Blob Kills: " + String(stats.blobKillCount) +
                    " Bot Kills: " + String(stats.botKillCount) +
                    " Toxin throws: " + String(stats.toxinThrow)

                var statsNode1 = $("<div></div>");
                statsNode1.css({
                    position: "relative",
                    left: 0,
                    fontSize: "14px",
                    fontFamily: "Courier New"
                });
                statsNode1.html(statsString1);

                statsString2 =
                    "---\> " +
                    " Successful Toxin throws: " + String(stats.successfulToxin) +
                    " Splits: " + String(stats.splitCount) +
                    " Successful Splits: " + String(stats.successfulSplit) +
                    " Good Teaming: " + String(stats.successfulTeaming) +
                    " Bad Teaming: " + String(stats.badTeaming)

                var statsNode2 = $("<div></div>");
                statsNode2.css({
                    position: "relative",
                    left: 0,
                    fontSize: "14px",
                    fontFamily: "Courier New"
                });
                statsNode2.html(statsString2);

                var barNode = $("<div></div>");
                barNode.css({
                    position: "relative",
                    background: makeCSSColor(botInfo.color),
                    top: 1,
                    //width: 280 * (mass / maxMass),
                    width: 888 * (mass / maxMass),
                    height: 10,
                    "border-style": "solid",
                    "border-width": "1px",
                    "border-color": "black",
                });

                containerNode.append(nameNode);
                containerNode.append(pointsNode);
                containerNode.append(statsNode1);
                containerNode.append(statsNode2);
                containerNode.append(barNode);

                return containerNode;
                //highscore.append(containerNode);
            }

            function updateHighscore() {

                var highscore = $("#highscore");
                highscore.empty();

                if (!showStats) {
                    return;
                }

                var scores = calculateHighscore();
                var tuples = scores[0];
                var maxMass = scores[1];

                for (var i = 0; i < tuples.length; i++) {
                    var mass = tuples[i].mass;
                    var botInfoId = tuples[i].id;

                    // VERY quick and dirty. Should be reworked, so that calculateHighscore is not called all the time.
                    // But we kinda need maxMass. Or we don't show the bar in follower-mode...
                    if (cameraMode == cmShowBot && botInfoId != cameraBotToFollow) {
                        continue;
                    }
                    containerNode = updateHighscoreForBotId(botInfoId, mass, maxMass);
                    highscore.append(containerNode);
                }


            }
        </script>
    </body>
</html>
